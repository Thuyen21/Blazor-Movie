@page "/AdminAccountManagement"
@attribute [Authorize(Roles = "Admin")]

<head>
	<meta charset="UTF-8">
	<link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
	<section class="home-section">
		<nav>
			<div class="sidebar-button">
				<span class="dashboard">Dashboard</span>
			</div>
			<div class="search-box" style="margin-right:20%">
				<input type="text" placeholder="Search..." @bind="@searchString">
				<i class='bx bx-search' @onclick="Search"></i>
			</div>
			@*<div></div><div></div>*@
		</nav>
		<div class="home-content">
			<div class="overview-boxes">
				<div class="box">
					<div class="right-side">
						<div class="box-topic">Total Order</div>
						<div class="number">40,876</div>
						<div class="indicator">
							<i class='bx bx-up-arrow-alt'></i>
							<span class="text">Up from yesterday</span>
						</div>
					</div>
					<i class='bx bx-cart-alt cart'></i>
				</div>
				<div class="box">
					<div class="right-side">
						<div class="box-topic">Total Sales</div>
						<div class="number">38,876</div>
						<div class="indicator">
							<i class='bx bx-up-arrow-alt'></i>
							<span class="text">Up from yesterday</span>
						</div>
					</div>
					<i class='bx bxs-cart-add cart two'></i>
				</div>
				<div class="box">
					<div class="right-side">
						<div class="box-topic">Total Profit</div>
						<div class="number">$12,876</div>
						<div class="indicator">
							<i class='bx bx-up-arrow-alt'></i>
							<span class="text">Up from yesterday</span>
						</div>
					</div>
					<i class='bx bx-cart cart three'></i>
				</div>
				<div class="box">
					<div class="right-side">
						<div class="box-topic">Total Return</div>
						<div class="number">11,086</div>
						<div class="indicator">
							<i class='bx bx-down-arrow-alt down'></i>
							<span class="text">Down From Today</span>
						</div>
					</div>
					<i class='bx bxs-cart-download cart four'></i>
				</div>
			</div>
		</div>
		@if (accs == null)
		{
			<p>
				<em>Loading...</em>
			</p>
		}
		else
		{
			<div class="home-content">
				<div class="sales-boxes">
					<div class="recent-sales box">
						<div class="title">Account manager</div>
						<div class="sales-details">
							<ul class="details">
								<div class="button" style="margin:10px" @onclick="EmailSortParm">
									<a style="cursor: pointer;">Sort by Email</a>
								</div>
							</ul>
							<ul class="details">
								<div class="button" style="margin:10px" @onclick="EmailSortParm">
									<a style="cursor: pointer;">Sort by Name</a>
								</div>
							</ul>
							<ul class="details">
								<div class="button" style="margin:10px" @onclick="DateSortParm">
									<a style="cursor: pointer;">Sort by DoB</a>
								</div>
							</ul>
						</div>


						<div class="sales-details">
							<ul class="details">
								<li class="topic">ID</li>
								@foreach (var acc in accs)
								{
									<li style="overflow: hidden; text-overflow: ellipsis; max-width: 150px; margin-right: 10px;"><a href="#">@acc.Id</a></li>
								}

							</ul>
							<ul class="details">
								<li class="topic"><i class='bx bx-mail-send'></i> Email</li>
								@foreach (var acc in accs)
								{
									<li style="overflow: hidden; text-overflow: ellipsis; max-width: 200px; margin-right: 10px;"><a href="#">@acc.Email</a></li>
								}
							</ul>
							<ul class="details">
								<li class="topic"><i class='bx bx-user'></i> Name</li>
								@foreach (var acc in accs)
								{
									<li style="overflow: hidden; text-overflow: ellipsis; max-width: 200px; margin-right: 10px;"><a href="#">@acc.Name</a></li>
								}
							</ul>
							<ul class="details">
								<li class="topic"><i class='bx bx-network-chart'></i> Role</li>
								@foreach (var acc in accs)
								{
									<li style="overflow: hidden; text-overflow: ellipsis; max-width: 100px; margin-right: 10px;"><a href="#">@acc.Role</a></li>
								}
							</ul>
							<ul class="details">
								<li class="topic"><i class='bx bx-calendar'></i> DOB</li>
								@foreach (var acc in accs)
								{
									<li style="overflow: hidden; text-overflow: ellipsis; max-width: 150px; margin-right: 10px;"><a href="#">@acc.DateOfBirth.ToShortDateString()</a></li>
								}
							</ul>
							<ul class="details">
								<li class="topic"><i class='bx bx-wallet'></i> Wallet</li>
								@foreach (var acc in accs)
								{
									<li style="overflow: hidden; text-overflow: ellipsis; max-width: 150px; margin-right: 10px;"><a href="#">@acc.Wallet</a></li>
								}

							</ul>
							<ul class="details">
								<li class="topic"><i class='bx bxs-traffic-cone'></i> Action</li>
								@foreach (var acc in accs)
								{
									<li>
										@{
											var linkEdit = $"EditAccount/{acc.Id}"; var linkBan = $"BanAccount/{acc.Id}";
										}
										<div class="button">
											<a href="@linkEdit" style="margin-right:5px">Edit</a>
											<a href="@linkBan" style="margin-left:5px">Ban</a>
										</div>
									</li>
								}
							</ul>
						</div>
						<div class="button" style="margin:10px" @onclick="LoadMore">
							<a style="cursor: pointer;">Load More</a>
						</div>
					</div>
				</div>
			</div>
		}
		@* Here is end else*@

	</section>

</body>


@code{
	private List<AccountManagementModel> accs { get; set; } = new();
        private int index = 0;
        private string? searchString { get; set; }

        private bool isSearch = false;
        private string sort = null;
        private async Task NameSortParm()
        {
            index = 0;
            sort = sort == "name" ? "nameDesc" : "name";
            accs = await _httpClient.GetFromJsonAsync<List<AccountManagementModel>>($"Admin/AccountManagement/ /{sort}/{index}");
            isSearch = false;
            searchString = null;
        }

        private async Task DateSortParm()
        {
            index = 0;
            sort = sort == "date" ? "dateDesc" : "date";
            accs = await _httpClient.GetFromJsonAsync<List<AccountManagementModel>>($"Admin/AccountManagement/ /{sort}/{index}");
            isSearch = false;
            searchString = null;
        }

        private async Task EmailSortParm()
        {
            index = 0;
            sort = sort == "email" ? "emailDesc" : "email";
            accs = await _httpClient.GetFromJsonAsync<List<AccountManagementModel>>($"Admin/AccountManagement/ /{sort}/{index}");
            isSearch = false;
            searchString = null;
        }

        private async Task Search()
        {
            index = 0;
            if (searchString != null)
            {
                accs = await _httpClient.GetFromJsonAsync<List<AccountManagementModel>>($"admin/AccountManagement/{searchString}/ /{index}");
                isSearch = true;
            }
            else
            {
                accs = await _httpClient.GetFromJsonAsync<List<AccountManagementModel>>($"admin/AccountManagement/ / /{index}");
                isSearch = false;
            }

            sort = null;
        }

        protected override async Task OnInitializedAsync()
        {
            accs = await _httpClient.GetFromJsonAsync<List<AccountManagementModel>>($"admin/AccountManagement/ / /{index}");
        }

        private async Task LoadMore()
        {
            index++;
            if (isSearch)
            {
                accs.AddRange(await _httpClient.GetFromJsonAsync<List<AccountManagementModel>>($"admin/AccountManagement/{searchString}//{index}"));
            }
            else if (sort != null)
            {
                accs.AddRange(await _httpClient.GetFromJsonAsync<List<AccountManagementModel>>($"admin/AccountManagement/ /{sort}/{index}"));
            }
            else
            {
                accs.AddRange(await _httpClient.GetFromJsonAsync<List<AccountManagementModel>>($"admin/AccountManagement/ / /{index}"));
            }
        }
}

